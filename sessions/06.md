# Session 06: Real-Time Reveal SSE Debugging

**Date:** 2026-01-03
**Session Goal:** Debug SSE real-time reveal sync issue

## Problem Summary

When host clicks "Reveal Now!", the reveal countdown and display shows on the host's page but does NOT sync to other connected clients in real-time. Guests only see the update after refreshing their page.

## Symptoms

1. Host clicks "ðŸŽ‰ Reveal Now! ðŸŽ‰" button
2. Host sees 10-second dramatic countdown â†’ confetti â†’ reveal display
3. Other clients see nothing (no countdown, no reveal)
4. Other clients must refresh page to see the revealed state
5. Connection status indicator shows "connected" (green) for all clients

## Root Cause Analysis

### Room Code Casing Issues (FIXED)

**Original Problem:**
- Old rooms stored with mixed case (e.g., "AbCd12")
- URL params lowercase: `/rooms/abcd12`
- SSE connections: Uppercase ("ABCD12")
- Events broadcast to: Mixed case ("AbCd12")
- Result: Different "rooms" in SSE manager â†’ no events reaching guests

**Fix Applied:**
- Room creation: Store `code.toUpperCase()`
- All queries: Use `code.toUpperCase()`
- All SSE: Use uppercase for connections and broadcasts
- All API endpoints: Consistent uppercase room codes

**Status:** âœ… Fixed - All room codes now uppercase

### Host ID Duplication (FIXED)

**Original Problem:**
- Reused `hostId` from localStorage for each new room
- MongoDB unique constraint: `guestId + roomCode`
- Result: Duplicate key error on room creation

**Fix Applied:**
- Generate fresh `crypto.randomUUID()` for each room creation
- Never reuse old host IDs

**Status:** âœ… Fixed - Can create multiple rooms

## Remaining Issues

### SSE Real-Time Sync Still Not Working

Even after fixing room code casing:
1. Create NEW room (uppercase code stored)
2. Join as host + 2+ guests in separate browsers
3. All show "connected" status (green indicator)
4. Host clicks "ðŸŽ‰ Reveal Now! ðŸŽ‰"
5. Host sees countdown â†’ reveal
6. **Guests see nothing** (no countdown, no reveal)
7. Guests must refresh to see update

## Debugging Checklist

### API Endpoint Verification
- [ ] Verify `POST /api/rooms/[code]/reveal` is called
- [ ] Check response status (should be 200)
- [ ] Verify `sseManager.broadcastToRoom()` is called
- [ ] Check room code used in broadcast

### SSE Connection Verification
- [ ] Confirm all clients connect to `/api/rooms/[code]/events`
- [ ] Verify all use same uppercase room code
- [ ] Check SSE connections added to `sseManager`
- [ ] Verify connection status shows "connected"

### SSE Event Broadcasting
- [ ] Check `sseManager.broadcastToRoom()` finds correct room
- [ ] Verify all connections for room receive event
- [ ] Check event type matches (`reveal_triggered`)
- [ ] Verify event payload format

### Client-Side Event Handling
- [ ] Verify `useSSE` hook receives `reveal_triggered` event
- [ ] Check `onRevealTriggered` callback is called
- [ ] Verify state updates trigger re-render
- [ ] Check countdown sequence starts

## Debugging Commands to Run Tomorrow

### 1. Add Console Logging to SSE Manager

```typescript
// lib/sse.ts - broadcastToRoom method
console.log(`[SSE] Broadcasting to room: ${roomCode}, event: ${eventType}`);
console.log(`[SSE] Connections in room:`, this.rooms.get(roomCode)?.length);
console.log(`[SSE] Broadcasting to connections:`, connections);
```

### 2. Add Client-Side Logging

```typescript
// app/hooks/useSSE.ts - eventSource.onmessage
console.log(`[SSE Client] Received event:`, parsedEvent.type, parsedEvent.data);
```

### 3. Add Reveal Endpoint Logging

```typescript
// app/api/rooms/[code]/reveal/route.ts - POST
console.log(`[Reveal] Triggered by guest: ${guestId}, room: ${room.code}`);
console.log(`[Reveal] Broadcasting reveal_triggered to room: ${room.code.toUpperCase()}`);
```

### 4. Add Room Page Logging

```typescript
// app/rooms/[code]/page.tsx - onRevealTriggered
onRevealTriggered: () => {
  console.log('[Room Page] reveal_triggered event received');
  console.log('[Room Page] Starting countdown sequence');
  setRoom((prev) => prev ? { ...prev, status: 'revealed' } : null);
  startCountdownSequence();
},
```

## Potential Root Causes to Investigate

### 1. Vercel SSE Limitations
- Vercel may not support persistent SSE connections properly
- Could be dropping events during broadcast
- Consider using Pusher or polling as fallback

### 2. SSE Connection Timing
- Guests may connect AFTER reveal is triggered
- No event history in SSE â†’ miss the event
- Need to verify connection order

### 3. Event Source Caching
- Browsers may cache SSE connections
- Old connections may not receive new events
- May need force reconnection

### 4. Broadcast Exclusion
- Current code excludes sender from broadcast
- May be incorrectly excluding host from receiving their own reveal
- Check `broadcastToRoom` implementation

## Next Steps for Tomorrow

1. **Add comprehensive logging** to SSE flow
2. **Create test room** and log everything
3. **Analyze logs** to find where event is lost
4. **Consider Pusher** if SSE limitations confirmed
5. **Test polling fallback** if SSE unreliable

## Files Modified This Session

- `app/api/rooms/route.ts` - Fixed room code to uppercase
- `app/api/rooms/[code]/route.ts` - Fixed query to uppercase
- `app/api/rooms/[code]/join/route.ts` - Fixed to uppercase
- `app/api/rooms/[code]/reveal/route.ts` - Fixed query/broadcast to uppercase
- `app/api/rooms/[code]/events/route.ts` - Already using uppercase
- `app/api/activities/route.ts` - Fixed to uppercase
- `app/create/page.tsx` - Fixed host ID generation
- `app/rooms/[code]/page.tsx` - Moved RevealDisplay to top

## Git Commits

- `2492851` - Fix: Move countdown to top and fix SSE real-time reveal broadcasts
- `3ea847a` - Fix: Move reveal display to top and fix room code casing in API
- `6edf358` - Fix: Generate new host ID for each room creation
