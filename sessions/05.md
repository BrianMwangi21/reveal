# Session 05 - Real-Time Integration (SSE)

**Date**: January 3, 2026
**Phase**: 4 - Real-Time WebSocket Integration
**Status**: ✅ Completed

## Summary

Implemented Server-Sent Events (SSE) for real-time synchronization across all connected guests in reveal rooms. Chose SSE over WebSocket libraries because it works natively on Vercel and provides sufficient one-way updates for this use case.

## Tech Decisions

### Why SSE over WebSocket?
- **Vercel Compatibility**: Vercel doesn't support persistent WebSocket connections
- **One-way is sufficient**: Clients use REST API for sending actions, only need server → client broadcasts
- **Simpler implementation**: Native HTTP-based, no external libraries needed
- **Free**: No external service costs (unlike Pusher)

### Key Implementation Details
1. **Keepalive mechanism**: 30s interval prevents Vercel's ~30s timeout on idle connections
2. **Staggered connections**: 0-2s random delay + jitter on reconnection prevents thundering herd
3. **Exponential backoff**: 1s → 2s → 4s retry delays for failed connections
4. **Rate limiting**: Reduced polling frequency to reduce server load
5. **Hybrid countdown**: Client-side calculation with server milestone events

## Files Created

### Server-Side
- `lib/sse.ts` (220 lines)
  - SSEConnection class for individual client connections
  - SSEConnectionManager for room-based broadcasting
  - Type-safe event interfaces
  - Room connection tracking

- `app/api/rooms/[code]/events/route.ts` (70 lines)
  - SSE endpoint with keepalive every 30s
  - Room validation and connection management
  - Broadcasts guest_left events on disconnect

### Client-Side
- `app/hooks/useSSE.ts` (135 lines)
  - React hook for SSE connection management
  - Auto-reconnect with exponential backoff (max 3 retries)
  - Connection status tracking
  - Event handlers for all SSE event types
  - Random initial delay to stagger connections

### Updated API Endpoints
Added SSE broadcasting to:
- `app/api/rooms/[code]/join/route.ts` - guest_joined events
- `app/api/activities/bet/[activityId]/bet/route.ts` - vote_cast events
- `app/api/activities/closestGuess/[activityId]/guess/route.ts` - guess_submitted events
- `app/api/activities/message/[activityId]/message/route.ts` - message_posted events
- `app/api/activities/message/[activityId]/message/[messageId]/react/route.ts` - message_reacted events
- `app/api/activities/route.ts` - activity_created events
- `app/api/activities/[activityId]/route.ts` - activity_deleted events

### Updated Components
- `app/rooms/[code]/page.tsx`
  - Integrated useSSE hook
  - Connection status indicator (green/yellow/red dot)
  - Reconnect button for failed connections
  - Real-time activity creation/deletion updates
  - Removed activity polling interval (now uses SSE events)

- `app/components/reveal/Bet.tsx`
  - Increased polling interval from 3s to 5s

- `app/components/reveal/ClosestGuess.tsx`
  - Increased polling interval from 3s to 5s

- `app/components/reveal/MessageBoard.tsx`
  - Increased polling interval from 3s to 5s

- `app/components/reveal/GuestList.tsx`
  - Increased polling interval from 5s to 10s

## SSE Events Implemented

| Event Type | Purpose | Broadcasted By |
|-----------|---------|----------------|
| `guest_joined` | New guest joins room | join endpoint |
| `guest_left` | Guest disconnects | SSE endpoint (on abort) |
| `vote_cast` | Bet placed | bet endpoint |
| `guess_submitted` | Closest guess made | guess endpoint |
| `message_posted` | Message sent | message endpoint |
| `message_reacted` | Emoji reaction | react endpoint |
| `activity_created` | New activity added | activities POST |
| `activity_deleted` | Activity removed | activities DELETE |
| `keepalive` | Prevent timeout | SSE endpoint (every 30s) |
| `countdown_milestone` | Timer events | (pending - Phase 5) |

## Challenges & Solutions

### Challenge 1: Next.js 15+ API Route Params
**Problem**: `params` is now a Promise and must be awaited
**Solution**: Updated all API routes to use `await params`

### Challenge 2: Vercel Timeout on Idle Connections
**Problem**: Vercel closes connections after ~30s of inactivity
**Solution**: Added keepalive event every 30s to keep connection alive

### Challenge 3: Thundering Herd Problem
**Problem**: Multiple clients reconnecting simultaneously caused cascading 404s and high CPU load
**Solution**: Added random delays (0-2s initial, jitter on reconnect) to stagger connections

### Challenge 4: Intermittent 404 Errors
**Problem**: Room not found errors even when room exists
**Solution**: Added database connection to SSE endpoint (was missing initially)

### Challenge 5: High CPU Load with Multiple Clients
**Problem**: 3 browsers with frequent polling caused fans to spin up
**Solution**: Reduced polling frequency, increased keepalive interval, added debouncing

## Performance Optimizations

1. **Reduced API calls**:
   - Activity components: 3s → 5s polling
   - Guest list: 5s → 10s polling
   - Keepalive: 15s → 30s interval

2. **Connection staggering**:
   - Random initial delay (0-2s) prevents simultaneous connections
   - Jitter (0-1s) on reconnections

3. **Debounced reconnections**:
   - Timeout tracking prevents rapid successive connection attempts
   - Exponential backoff: 1s → 2s → 4s

4. **Removed unnecessary polling**:
   - Room page no longer polls for activities (uses SSE events)

## Testing Recommendations

### Local Testing
1. Open 3+ browser windows
2. Join the same room with different nicknames
3. Test real-time features:
   - Create/delete activities (should appear instantly on all clients)
   - Place bets, submit guesses, post messages
   - Close tabs (guest_left events broadcast)
   - Check connection status indicator stays green

### Connection Resilience Testing
1. Kill dev server (Ctrl+C)
2. Restart server
3. Observe auto-reconnect behavior
4. Check status indicator: yellow → green

### Vercel Deployment Testing
1. Deploy to Vercel
2. Test with multiple real users
3. Monitor for connection drops
4. Verify keepalive works (no 30s timeout)

## Known Limitations

1. **Hybrid approach**: Activities still poll every 5s for data (could be fully SSE in future)
2. **SSE is one-way**: Cannot use for client → server communication
3. **Vercel Serverless**: SSE connections are limited by serverless constraints
4. **State not persisted**: If server restarts, all connections must reconnect

## Next Steps (Phase 5)

Phase 5 will build the countdown timer and reveal logic:
- Dramatic countdown component with animations
- Timer synchronization across clients (hybrid client-side + milestone events)
- Reveal trigger API
- Different reveal formats based on room type (gender, baby, birthday, custom)
- Celebration animations (confetti, balloons)
- Lock all activities after reveal

## Metrics

- **Total lines of code added**: ~600
- **New files created**: 2 (lib/sse.ts, app/hooks/useSSE.ts)
- **Files modified**: 10
- **SSE events implemented**: 9 types
- **Connection retry attempts**: 3 max
- **Keepalive interval**: 30s
- **Polling intervals**: 5-10s (reduced from 3-5s)
